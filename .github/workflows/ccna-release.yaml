name: Run CCNA Parse and Update Releases

on:
  push:
    branches:
      - main
    paths:
      - 'R/**'
      - 'formats/**'
      - 'ccna-library-parse.R'
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    permissions:
      contents: write  # Needed for release creation

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up R
        uses: r-lib/actions/setup-r@v2

      - name: Install R packages
        run: |
          Rscript -e 'install.packages(c("rvest", "dplyr", "fs", "zip", "writexl", "stringr", "httr", "jsonlite", "readr", "purrr", "digest"))'

      - name: Run parsing script
        run: |
          mkdir -p output/zips
          Rscript R/scrpits/ccna-library-parse.R output/zips

      - name: Upload files to GitHub Release(s)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          for f in output/zips/*; do
            name=$(basename "$f")
            tag=$(echo "$name" | cut -d'_' -f1)
            
            # Check if release exists
            if ! gh release view "$tag" &>/dev/null; then
              echo "Creating release $tag"
              gh release create "$tag" -t "$tag" -n "Auto-generated release for $tag"
            fi

            echo "Uploading $name to release $tag"
            gh release upload "$tag" "$f" --clobber
          done
